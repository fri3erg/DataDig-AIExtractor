# Copyright (c) 2010-2023 openpyxl

from openpyxl.xml.functions import (
    Element,
    SubElement,
    tostring,
)

from openpyxl.utils import coordinate_to_tuple

vmlns = "urn:schemas-microsoft-com:vml"
officens = "urn:schemas-microsoft-com:office:office"
excelns = "urn:schemas-microsoft-com:office:excel"


class ShapeWriter(object):
    """
    Create VML for comments
    """

    vml = None
    vml_path = None


    def __init__(self, comments):
        self.comments = comments


    def add_comment_shapetype(self, root):
        shape_layout = SubElement(root, "{%s***REMOVED***shapelayout" % officens,
                                  {"{%s***REMOVED***ext" % vmlns: "edit"***REMOVED***)
        SubElement(shape_layout,
                   "{%s***REMOVED***idmap" % officens,
                   {"{%s***REMOVED***ext" % vmlns: "edit", "data": "1"***REMOVED***)
        shape_type = SubElement(root,
                                "{%s***REMOVED***shapetype" % vmlns,
                                {"id": "_x0000_t202",
                                 "coordsize": "21600,21600",
                                 "{%s***REMOVED***spt" % officens: "202",
                                 "path": "m,l,21600r21600,l21600,xe"***REMOVED***)
        SubElement(shape_type, "{%s***REMOVED***stroke" % vmlns, {"joinstyle": "miter"***REMOVED***)
        SubElement(shape_type,
                   "{%s***REMOVED***path" % vmlns,
                   {"gradientshapeok": "t",
                    "{%s***REMOVED***connecttype" % officens: "rect"***REMOVED***)


    def add_comment_shape(self, root, idx, coord, height, width):
        row, col = coordinate_to_tuple(coord)
        row -= 1
        col -= 1
        shape = _shape_factory(row, col, height, width)

        shape.set('id', "_x0000_s%04d" % idx)
        root.append(shape)


    def write(self, root):

        if not hasattr(root, "findall"):
            root = Element("xml")

        # Remove any existing comment shapes
        comments = root.findall("{%s***REMOVED***shape[@type='#_x0000_t202']" % vmlns)
        for c in comments:
            root.remove(c)

        # check whether comments shape type already exists
        shape_types = root.find("{%s***REMOVED***shapetype[@id='_x0000_t202']" % vmlns)
        if shape_types is None:
            self.add_comment_shapetype(root)

        for idx, (coord, comment) in enumerate(self.comments, 1026):
            self.add_comment_shape(root, idx, coord, comment.height, comment.width)

        return tostring(root)


def _shape_factory(row, column, height, width):
    style = ("position:absolute; "
             "margin-left:59.25pt;"
             "margin-top:1.5pt;"
             "width:{width***REMOVED***px;"
             "height:{height***REMOVED***px;"
             "z-index:1;"
             "visibility:hidden").format(height=height,
                                         width=width)
    attrs = {
        "type": "#_x0000_t202",
        "style": style,
        "fillcolor": "#ffffe1",
        "{%s***REMOVED***insetmode" % officens: "auto"
    ***REMOVED***
    shape = Element("{%s***REMOVED***shape" % vmlns, attrs)

    SubElement(shape, "{%s***REMOVED***fill" % vmlns,
               {"color2": "#ffffe1"***REMOVED***)
    SubElement(shape, "{%s***REMOVED***shadow" % vmlns,
               {"color": "black", "obscured": "t"***REMOVED***)
    SubElement(shape, "{%s***REMOVED***path" % vmlns,
               {"{%s***REMOVED***connecttype" % officens: "none"***REMOVED***)
    textbox = SubElement(shape, "{%s***REMOVED***textbox" % vmlns,
                         {"style": "mso-direction-alt:auto"***REMOVED***)
    SubElement(textbox, "div", {"style": "text-align:left"***REMOVED***)
    client_data = SubElement(shape, "{%s***REMOVED***ClientData" % excelns,
                             {"ObjectType": "Note"***REMOVED***)
    SubElement(client_data, "{%s***REMOVED***MoveWithCells" % excelns)
    SubElement(client_data, "{%s***REMOVED***SizeWithCells" % excelns)
    SubElement(client_data, "{%s***REMOVED***AutoFill" % excelns).text = "False"
    SubElement(client_data, "{%s***REMOVED***Row" % excelns).text = str(row)
    SubElement(client_data, "{%s***REMOVED***Column" % excelns).text = str(column)
    return shape
